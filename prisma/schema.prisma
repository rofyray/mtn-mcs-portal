generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  FULL
  MANAGER
  COORDINATOR
  SENIOR_MANAGER
  GOVERNANCE
}

enum AdminOtpStatus {
  PENDING
  USED
  EXPIRED
}

enum OnboardingStatus {
  DRAFT
  SUBMITTED
  APPROVED
  DENIED
  EXPIRED
}

enum ReviewStatus {
  SUBMITTED
  APPROVED
  DENIED
  EXPIRED
}

enum NotificationCategory {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum NotificationRecipientType {
  ADMIN
  PARTNER
}

enum FormStatus {
  SENT
  SIGNED
  REJECTED
}

enum FeedbackStatus {
  OPEN
  RESPONDED
  CLOSED
}

enum RequestStatus {
  OPEN
  RESPONDED
  CLOSED
}

enum AuditAction {
  PARTNER_APPROVED
  PARTNER_DENIED
  PARTNER_EDITED
  PARTNER_EXPIRED
  AGENT_APPROVED
  AGENT_DENIED
  AGENT_EDITED
  AGENT_EXPIRED
  BUSINESS_APPROVED
  BUSINESS_DENIED
  BUSINESS_EDITED
  BUSINESS_EXPIRED
  ADMIN_REGION_ASSIGNED
  ADMIN_REGION_REMOVED
  ADMIN_ENABLED
  ADMIN_DISABLED
  FORM_SENT
  FORM_SIGNED
  ONBOARD_REQUEST_CREATED
  ONBOARD_REQUEST_SUBMITTED_TO_MANAGER
  ONBOARD_REQUEST_SUBMITTED_TO_SENIOR_MANAGER
  ONBOARD_REQUEST_SUBMITTED_TO_GOVERNANCE
  ONBOARD_REQUEST_APPROVED
  ONBOARD_REQUEST_DENIED
  ONBOARD_REQUEST_PUBLIC_SUBMITTED
  ONBOARD_REQUEST_EDITED
  ADMIN_CREATED
  PARTNER_SUSPENDED
  PARTNER_UNSUSPENDED
  PARTNER_DELETED
  FEEDBACK_REPLIED
  FEEDBACK_CLOSED
  RESTOCK_REQUEST_REPLIED
  RESTOCK_REQUEST_CLOSED
  TRAINING_REQUEST_REPLIED
  TRAINING_REQUEST_CLOSED
  REPORT_GENERATED
}

enum OnboardRequestStatus {
  PENDING_COORDINATOR
  DRAFT
  PENDING_MANAGER
  PENDING_SENIOR_MANAGER
  PENDING_GOVERNANCE_CHECK
  APPROVED
  DENIED
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  partnerProfile PartnerProfile?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  identifier String   // User email (lowercase)
  token      String   @unique // SHA-256 hash of raw token
  expires    DateTime

  @@unique([identifier, token])
}

model Admin {
  id        String    @id @default(cuid())
  name      String
  email     String    @unique
  role      AdminRole @default(COORDINATOR)
  enabled   Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  otps       AdminOtp[]
  sessions   AdminSession[]
  regions    AdminRegionAssignment[]
  auditLogs  AuditLog[]
  onboardRequestsCreated  OnboardRequestForm[]
  onboardRequestApprovals OnboardRequestApproval[]
}

model AdminOtp {
  id        String         @id @default(cuid())
  adminId   String
  codeHash  String
  status    AdminOtpStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime       @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, status])
}

model AdminRegionAssignment {
  id         String   @id @default(cuid())
  adminId    String
  regionCode String
  sbuCode    String?
  createdAt  DateTime @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, regionCode])
}

model AdminSession {
  id           String   @id @default(cuid())
  adminId      String
  sessionToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

model PartnerProfile {
  id                       String           @id @default(cuid())
  userId                   String           @unique
  status                   OnboardingStatus @default(DRAFT)
  submittedAt              DateTime?
  approvedAt               DateTime?
  deniedAt                 DateTime?
  denialReason             String?
  suspended                Boolean          @default(false)
  suspendedAt              DateTime?
  businessName             String?
  partnerFirstName         String?
  partnerSurname           String?
  phoneNumber              String?
  paymentWallet            String?
  ghanaCardNumber           String?
  ghanaCardFrontUrl         String?
  ghanaCardBackUrl          String?
  passportPhotoUrl          String?
  taxIdentityNumber        String?
  businessCertificateUrl    String?
  fireCertificateUrl        String?
  insuranceUrl              String?
  apn                       String?
  mifiImei                  String?
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  agents    Agent[]
  businesses Business[]
  trainingRequests TrainingRequest[]
  restockRequests RestockRequest[]
  feedbackItems Feedback[]
  formRequests FormRequest[]

  @@index([status])
}

model Agent {
  id                 String       @id @default(cuid())
  partnerProfileId   String
  businessId         String
  status             ReviewStatus @default(SUBMITTED)
  submittedAt        DateTime     @default(now())
  approvedAt         DateTime?
  deniedAt           DateTime?
  denialReason       String?
  firstName          String
  surname            String
  phoneNumber        String
  email              String
  cpAppNumber        String?
  agentUsername       String?
  minervaReferralCode String?
  ghanaCardNumber    String
  ghanaCardFrontUrl  String?
  ghanaCardBackUrl   String?
  passportPhotoUrl   String?
  businessName       String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  partnerProfile PartnerProfile @relation(fields: [partnerProfileId], references: [id], onDelete: Cascade)
  business       Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([partnerProfileId])
  @@index([status])
}

model Business {
  id                 String       @id @default(cuid())
  partnerProfileId   String
  status             ReviewStatus @default(SUBMITTED)
  submittedAt        DateTime     @default(now())
  approvedAt         DateTime?
  deniedAt           DateTime?
  denialReason       String?
  businessName       String
  addressRegionCode  String
  addressSbuCode     String?
  addressDistrictCode String
  addressCode        String
  gpsLatitude        String?
  gpsLongitude       String?
  city               String
  landmark           String?
  storeFrontUrl      String?
  storeInsideUrl     String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  partnerProfile PartnerProfile @relation(fields: [partnerProfileId], references: [id], onDelete: Cascade)
  restockRequests RestockRequest[]
  agents          Agent[]

  @@index([partnerProfileId])
  @@index([status])
  @@index([addressRegionCode])
  @@index([addressSbuCode])
}

model Notification {
  id            String                     @id @default(cuid())
  recipientType NotificationRecipientType
  recipientAdminId String?
  recipientUserId  String?
  title         String
  message       String
  category      NotificationCategory @default(INFO)
  readAt        DateTime?
  createdAt     DateTime             @default(now())

  @@index([recipientAdminId])
  @@index([recipientUserId])
  @@index([recipientType, recipientAdminId, readAt])
}

model TrainingRequest {
  id              String        @id @default(cuid())
  partnerProfileId String
  agentIds        String[]
  agentNames      String[]
  message         String?
  status          RequestStatus @default(OPEN)
  createdAt       DateTime      @default(now())

  partnerProfile PartnerProfile @relation(fields: [partnerProfileId], references: [id], onDelete: Cascade)
  replies        TrainingRequestReply[]
}

model RestockRequest {
  id               String        @id @default(cuid())
  partnerProfileId String
  businessId       String
  items            String[]
  message          String?
  status           RequestStatus @default(OPEN)
  createdAt        DateTime      @default(now())

  partnerProfile PartnerProfile @relation(fields: [partnerProfileId], references: [id], onDelete: Cascade)
  business       Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  replies        RestockRequestReply[]
}

model Feedback {
  id              String         @id @default(cuid())
  partnerProfileId String
  title           String
  message         String
  status          FeedbackStatus @default(OPEN)
  createdAt       DateTime       @default(now())

  partnerProfile PartnerProfile @relation(fields: [partnerProfileId], references: [id], onDelete: Cascade)
  replies        FeedbackReply[]
}

model FeedbackReply {
  id              String   @id @default(cuid())
  feedbackId      String
  message         String
  senderType      String   // "ADMIN" or "PARTNER"
  senderAdminId   String?
  senderPartnerId String?
  createdAt       DateTime @default(now())

  feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@index([feedbackId])
}

model FormRequest {
  id              String     @id @default(cuid())
  partnerProfileId String
  title           String
  documentUrl     String
  status          FormStatus @default(SENT)
  signedAt        DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  partnerProfile PartnerProfile @relation(fields: [partnerProfileId], references: [id], onDelete: Cascade)
  signature      FormSignature?

  @@index([partnerProfileId])
  @@index([status])
}

model FormSignature {
  id            String   @id @default(cuid())
  formRequestId String   @unique
  signerName    String
  signedAt      DateTime @default(now())
  signatureUrl  String

  formRequest FormRequest @relation(fields: [formRequestId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id            String     @id @default(cuid())
  adminId       String?
  action        AuditAction
  targetType    String
  targetId      String
  metadata      Json?
  createdAt     DateTime   @default(now())

  admin Admin? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([adminId])
  @@index([createdAt])
}

model OnboardRequestForm {
  id                    String               @id @default(cuid())
  status                OnboardRequestStatus @default(DRAFT)
  createdByAdminId      String?
  regionCode            String
  sbuCode               String?

  // Submitter info (public form submissions)
  submitterName         String?
  submitterEmail        String?
  submitterPhone        String?

  // Company details
  businessName          String
  dateOfIncorporation   DateTime?
  businessType          String?
  businessTypeOther     String?
  registeredNature      String?
  registrationCertNo    String?
  mainOfficeLocation    String?
  tinNumber             String?
  postalAddress         String?
  physicalAddress       String?
  companyPhone          String?
  digitalPostAddress    String?

  // Authorized signatory & contact person (JSON: { name, designation, phone, email, date })
  authorizedSignatory   Json?
  contactPerson         Json?

  // PEP declaration (JSON: { q1, q2, q2Timeframe, q3, q3Details })
  pepDeclaration        Json?

  // Photos (up to 5)
  imageUrls             String[]

  completionDate        DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  createdByAdmin        Admin?             @relation(fields: [createdByAdminId], references: [id], onDelete: SetNull)
  approvals             OnboardRequestApproval[]

  @@index([status])
  @@index([regionCode])
  @@index([sbuCode])
  @@index([createdByAdminId])
}

model OnboardRequestApproval {
  id                    String   @id @default(cuid())
  onboardRequestFormId  String
  adminId               String
  role                  AdminRole
  action                String   // "SUBMITTED" | "APPROVED" | "DENIED"
  comments              String?
  signatureUrl          String?
  signatureDate         DateTime?
  governanceScore       Int?     // 1-100, only for GOVERNANCE
  createdAt             DateTime @default(now())

  onboardRequestForm    OnboardRequestForm @relation(fields: [onboardRequestFormId], references: [id], onDelete: Cascade)
  admin                 Admin              @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([onboardRequestFormId])
  @@index([adminId])
}

model RestockRequestReply {
  id               String   @id @default(cuid())
  restockRequestId String
  message          String
  senderType       String   // "ADMIN" or "PARTNER"
  senderAdminId    String?
  senderPartnerId  String?
  createdAt        DateTime @default(now())

  restockRequest RestockRequest @relation(fields: [restockRequestId], references: [id], onDelete: Cascade)

  @@index([restockRequestId])
}

model TrainingRequestReply {
  id                String   @id @default(cuid())
  trainingRequestId String
  message           String
  senderType        String   // "ADMIN" or "PARTNER"
  senderAdminId     String?
  senderPartnerId   String?
  createdAt         DateTime @default(now())

  trainingRequest TrainingRequest @relation(fields: [trainingRequestId], references: [id], onDelete: Cascade)

  @@index([trainingRequestId])
}
